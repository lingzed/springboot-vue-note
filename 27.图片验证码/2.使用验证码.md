# 1 验证码接口

验证码一般是前端页面发送异步请求，后端将流响应给前端，前端将流写成图片，因此我们需要一个接口为前端提供验证码：

```java
@GetMapping("/checkCode")
    public void getImageCode(HttpServletResponse response) throws IOException {
        ImageCode imageCode = new ImageCode(130, 38, 5, 10);
        response.setHeader("Pragma", "no-cache");
        response.setHeader("Cache-Control", "no-cache");
        response.setDateHeader("Expires", 0);
        response.setContentType("image/jpeg");
        String code = imageCode.getCode();
        log.info("验证码: {}", code);
        imageCode.write(response.getOutputStream());
    }
```

验证码生成后，将验证码存储在session(可替换)中：

```java
@GetMapping("/checkCode")
public void getImageCode(HttpServletResponse response, HttpServletRequest request) throws IOException {
    ImageCode imageCode = new ImageCode(130, 38, 5, 10);
    response.setHeader("Pragma", "no-cache");
    response.setHeader("Cache-Control", "no-cache");
    response.setDateHeader("Expires", 0);
    response.setContentType("image/jpeg");
    String code = imageCode.getCode();
    log.info("验证码: {}", code);
    HttpSession session = request.getSession();			// 请求获取session会话
    // Constant常量类，存储常量
    session.setAttribute(Constant.CHECK_CODE, code);	// 将code存储在session中
    imageCode.write(response.getOutputStream());
}
```



# 2 校验验证码

验证码接口只做生成验证码和存储验证码的操作，而校验的业务则交给业务层来处理，在登录校验业务层中：

```java
public void loginValid(String username, String password, String code, HttpSession session) {
    String sCode = session.getAttribute(Constant.CHECK_CODE);		// 从session中取出验证码
    if(!code.toLowerCase().equals(sCode)) {
        throw new BusinessException(CommonMsg.LOGIN_FAIL)			// 如果验证码校验失败，抛出异常
    }
   
    // 用户名和密码的校验
    ...
}
```

